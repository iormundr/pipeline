- name: Check if httplib2 is installed
  stat:
    path: /usr/lib/python2.7/site-packages/httplib2
  register: httplib2

- name: Check if directories are present
  stat:
    path: /data/jenkins/
  register: directories

- name: Check if config.xml is present
  stat:
    path: /data/jenkins/config.xml
  register: configxml

- name: Check if plugins are present
  stat:
    path: /data/jenkins/plugins/workflow-multibranch.jpi
  register: plugins

- name: Install httplib2
  pip: name=httplib2
  when: httplib2.stat.exists == False


- name: Directories are present
  file:
    path='{{ item }}'
    state=directory
    mode=0777
  with_items: directories
  tags: [jenkins]
  when: directories.stat.exists == False

- name: slave nodes are present
  copy:
    src='nodes'
    dest='{{ jenkins_directory }}/'
    mode=0777
  tags: [jenkins]
  when: directories.stat.exists == False

- name: Config files are present
  copy:
    src='{{ item }}'
    dest='{{ jenkins_directory }}/{{ item }}'
    mode=0775
  with_items: configs
  tags: [jenkins]
  when: configxml.stat.exists == False

- name: Plugins are present
  copy:
    src='plugins'
    dest='{{ jenkins_directory }}/plugins'
    mode=0770
  tags: [jenkins]
  when: plugins.stat.exists == False

- name: Container is running
  docker:
    image: jenkins
    ports: 8080:8080
    volumes: /data/jenkins:/var/jenkins/
    state: started
  tags: [jenkins]
  register: running_container

- name: Reload
  uri:
    url=http://127.0.0.1:8080/reload
    method=POST
    status_code=302
  ignore_errors: yes
  tags: [jenkins]
  when: "'started 1 container' in running_container.msg"
